<div class="modal fade" id="userEditDialog" tabindex="-1" role="dialog" aria-labelledby="userEditDialogLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userEditDialogLabel">Edit user</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group fw-bold"
                         style="text-align: center">
                        <label for="user-id" class="col-form-label">ID</label>
                        <input type="text" class="form-control" id="user-id" disabled>
                    </div>
                    <div class="form-group fw-bold"
                         style="text-align: center">
                        <label for="user-name" class="col-form-label">Username</label>
                        <input type="text" class="form-control" id="user-name">
                    </div>
                    <div class="form-group fw-bold"
                         style="text-align: center">
                        <label for="user-password" class="col-form-label">Password</label>
                        <input type="password" class="form-control" id="user-password">
                    </div>
                    <div class="container login-form-field justify-content-center p-3"
                         style="text-align: center">
                        <label for="user-roles" class="fw-bold">Select roles (default - USER): </label>
                        <select id="user-roles"
                                multiple
                                th:object="${roles}"
                                th:field="${roles}"
                                class="form-control-sm"
                                style="width: 100%">
                            <option th:each="role : ${roles}"
                                    th:value="${role.id}"
                                    th:text="${role.name}">
                            </option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="save-user-button" type="button" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
    $('#userEditDialog').on('shown.bs.modal', function (event) {
        let button = $(event.relatedTarget)
        let userId = button.data('userid')
        if (userId) {
            $.get({
                url: '/api/' + userId,
                success: (data) => {
                    let modal = $(this)
                    modal.find('#user-id').val(data.id)
                    modal.find('#user-name').val(data.username)
                    modal.find('#user-password').val(data.password)
                },
                error: (err) => {
                    alert(err);
                }
            });
        }
    })

    $('#save-user-button').click(function () {
        let modal = $('#userEditDialog')
        let user = {};
        user.id = document.getElementById("user-id").value;
        user.username = document.getElementById("user-name").value;
        user.password = document.getElementById("user-password").value;
        let roles = document.getElementById("user-roles");
        let selectedRoles = [];
        for (let i = 0; i < roles.options.length; i++) {
            if (roles.options[i].selected) {
                selectedRoles.push({
                    id: roles.options[i].value,
                    name: roles.options[i].text,
                    authority: ""
                });
            }
        }
        user.roles = selectedRoles;
        let jsonData = JSON.stringify(user);
        console.log(jsonData);
        let token = $("meta[name='_csrf']").attr("content");
        $.ajax({
            url: '/api',
            type: 'POST',
            data: JSON.stringify(user),
            headers: {
                'X-CSRF-TOKEN': token
            },
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: () => {
                location.reload()
            },
            error: (err) => {
                alert(err);
            }
        })
        modal.modal('hide');
    })
    ;
</script>